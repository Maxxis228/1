DROP TABLE seg_;
CREATE TABLE seg_ AS (SELECT t.AGREEMENT_RK, s.PLAN_SME_PROFIT_MODEL_CD, s.PLAN_SME_PROFIT_SEGMENT_CD, s.PRIOR_MANAGER_FULL_NM
FROM ( SELECT c.*, x.CUSTOMER_GLOBAL_RK 
FROM ( SELECT DISTINCT AGREEMENT_RK, ISSUE_DT, CUSTOMER_RK FROM _contract ) c
JOIN CDM.TECH_CUSTOMER_X_GLOBAL x
ON (c.CUSTOMER_RK = x.CUSTOMER_RK) AND (c.ISSUE_DT BETWEEN x.EFFECTIVE_FROM_DTTM AND x.EFFECTIVE_TO_DTTM) AND (x.DELETED_FLG = '0') AND (x.CUSTOMER_GLOBAL_TYPE = 'MDM')
) t
JOIN  CDM.AGG_CORPORATE_SME_SEGMENT s ON s.CUSTOMER_GLOBAL_RK = t.CUSTOMER_GLOBAL_RK AND  MONTH_END (t.ISSUE_DT) = s.REPORT_DT
) WITH DATA;

DROP TABLE vint_adv;
CREATE TABLE vint_adv AS (SELECT * FROM vintage_advances) WITH DATA;
ALTER TABLE vint_adv ADD PLAN_SEGMENT VARCHAR(50) NOT NULL DEFAULT ' ', ADD PR_MANAGER VARCHAR(200) NOT NULL DEFAULT ' ';
UPDATE vint_adv FROM seg_ cc
SET PLAN_SEGMENT = COALESCE(cc.PLAN_SME_PROFIT_MODEL_CD, ' '), PR_MANAGER = COALESCE(cc.PRIOR_MANAGER_FULL_NM, ' ')
WHERE vint_adv.MIGR_ROOT_AGREEMENT_RK = cc.AGREEMENT_RK;

DROP TABLE vint_fin;
CREATE TABLE vint_fin AS (SELECT * FROM vintage_final) WITH DATA;
ALTER TABLE vint_fin ADD PLAN_SEGMENT VARCHAR(50) NOT NULL DEFAULT ' ', ADD PR_MANAGER VARCHAR(200) NOT NULL DEFAULT ' ';
UPDATE vint_fin FROM seg_ cc
SET PLAN_SEGMENT = COALESCE(cc.PLAN_SME_PROFIT_MODEL_CD, ' '), PR_MANAGER = COALESCE(cc.PRIOR_MANAGER_FULL_NM, ' ')
WHERE vint_fin.AGREEMENT_RK = cc.AGREEMENT_RK;

DROP TABLE portfolio_20160731;
CREATE TABLE portfolio_20160731 AS ( SELECT * FROM yastrebovaas.portfolio WHERE REPORT_DT = DATE '2016-07-31'
ALTER TABLE portfolio_20160731 ADD PLAN_SEGMENT VARCHAR(50) NOT NULL DEFAULT ' ', ADD PR_MANAGER VARCHAR(200) NOT NULL DEFAULT ' ';
UPDATE portfolio_20160731 FROM seg_ cc
SET PLAN_SEGMENT = COALESCE(cc.PLAN_SME_PROFIT_MODEL_CD, ' '), PR_MANAGER = COALESCE(cc.PRIOR_MANAGER_FULL_NM, ' ')
WHERE portfolio_20160731.AGREEMENT_RK = cc.AGREEMENT_RK;

ALTER TABLE portfolio_20160731 ADD CUSTOMER_RK INTEGER NOT NULL DEFAULT -1;
UPDATE portfolio_20160731 FROM _contract cc
SET CUSTOMER_RK = COALESCE(cc.CUSTOMER_RK, -1)
WHERE portfolio_20160731.AGREEMENT_RK = cc.AGREEMENT_RK;
