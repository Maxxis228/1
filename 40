DROP TABLE _contract ;
CREATE TABLE _contract AS (
SELECT DISTINCT
c.AGREEMENT_RK, c.MIGRATION_AGREEMENT_RK, c.CONTRACT_TYPE_CD AS AGREEMENT_TYPE_CD, c.SOURCE_SYSTEM_CD AS BRANCH_ID, 
c.CONTRACT_ID, TRUNC(COALESCE(c.MIGRATION_OPEN_DT, c.ISSUE_DT), 'mm') AS GENERATION,
COALESCE(SUM(lim.CREDIT_LIMIT_AMT) OVER (PARTITION BY c.AGREEMENT_RK), c.CONTRACT_AMT) AS CONTRACT_AMT,
COALESCE(c.MIGRATION_OPEN_DT, c.OPEN_DT) AS OPEN_DT, COALESCE(c.MIGRATION_OPEN_DT, c.ISSUE_DT) AS ISSUE_DT,
COALESCE(c.INIT_INTERNAL_ORG_2_RK, c.INIT_INTERNAL_ORG_RK) AS POS_DEPT_RK,
CASE WHEN PERIOD_TYPE = 'ДНЕЙ' THEN C.CONTRACT_PERIOD
	WHEN C.CONTRACT_PERIOD IS NOT NULL THEN ADD_MONTHS(COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT), C.CONTRACT_PERIOD) - COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT)
	WHEN C.CONTRACT_PERIOD IS NULL AND CLOSE_PLAN_DT IS NOT NULL THEN 
		CLOSE_PLAN_DT - COALESCE(CASE WHEN OPEN_DT >= DATE '2005-01-01' THEN OPEN_DT END, c.MIGRATION_OPEN_DT, c.ISSUE_DT) END AS TERM, 
CASE WHEN c.CLOSE_DT < CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) THEN c.CLOSE_DT ELSE CLOSE_PLAN_DT END AS CLOSE_DT, r.RATE, c.PRODUCT_OPERATIONAL_ID AS PRODUCT_ID, 
c.PRODUCT_SUB_ID AS SUBPRODUCT_ID, po.PRODUCT_OPERATIONAL_NM AS PRODUCT_TYPE, c.PURPOSE_CD AS PURPOSE, c.CUSTOMER_RK, c.CUSTOMER_TYPE_CD, 
cu.CUSTOMER_GLOBAL_ID, cu.CUSTOMER_FULL_NM AS CUSTOMER_NM, cu.BIRTH_DT, cu.TAX_PAYER_NUM AS CUSTOMER_TIN, o.OKVED_DESC, ch.OKVED_CODE     
	FROM DDS.CONTRACT_LN c 
		
	LEFT JOIN DDS.AGREEMENT_CREDIT_LIMIT_HIST lim
	ON (lim.AGREEMENT_RK = c.AGREEMENT_RK) AND (lim.AGREEMENT_TYPE_CD = c.CONTRACT_TYPE_CD) AND (lim.START_DT = c.ISSUE_DT)
	AND (CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) BETWEEN lim.EFFECTIVE_FROM_DTTM AND lim.EFFECTIVE_TO_DTTM) AND (lim.DELETED_FLG = '0') AND (lim.IS_ACTIVE_FLG = '1')
    
	LEFT JOIN DDS.AGREEMENT_RATE_HIST r
	ON (r.AGREEMENT_RK = c.AGREEMENT_RK) AND (r.AGREEMENT_TYPE_CD = c.CONTRACT_TYPE_CD)
	AND (CAST(c.ISSUE_DT AS TIMESTAMP(0)) BETWEEN r.EFFECTIVE_FROM_DTTM AND r.EFFECTIVE_TO_DTTM) AND (r.DELETED_FLG = '0') AND (r.IS_ACTIVE_FLG = '1')
 
	LEFT JOIN DDS.PRODUCT_OPERATIONAL_HIST po 
	ON (po.PRODUCT_OPERATIONAL_RK = c.PRODUCT_OPERATIONAL_RK) 
	AND (CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) BETWEEN po.EFFECTIVE_FROM_DTTM AND po.EFFECTIVE_TO_DTTM) AND (po.DELETED_FLG = '0') AND (po.IS_ACTIVE_FLG = '1')
    
	LEFT JOIN DDS.CUSTOMER_GLOBAL_REGISTRY cu
	ON (cu.CUSTOMER_RK = c.CUSTOMER_RK)
	AND (CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) BETWEEN cu.EFFECTIVE_FROM_DTTM AND cu.EFFECTIVE_TO_DTTM) AND (cu.DELETED_FLG = '0') AND (cu.IS_ACTIVE_FLG = '1')
    	 
	LEFT JOIN (
	SELECT CUSTOMER_RK, CUSTOMER_TYPE_CD, TD_SYSFNLIB.REGEXP_SUBSTR(TRIM(BOTH ',' FROM TRIM(OKVED_CD)),'[^,]+') AS OKVED_CODE 
	FROM DDS.CORPORATE_HIST 
	WHERE (CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) BETWEEN EFFECTIVE_FROM_DTTM AND EFFECTIVE_TO_DTTM) AND (DELETED_FLG = '0') AND (IS_ACTIVE_FLG = '1') 
	) ch 
	ON (ch.CUSTOMER_RK = c.CUSTOMER_RK)
	
	LEFT JOIN DDS.DIM_OKVED o
	ON (o.OKVED_CD = ch.OKVED_CODE)
	AND (CAST(CURRENT_TIMESTAMP(0) AS TIMESTAMP(0)) BETWEEN o.EFFECTIVE_FROM_DTTM AND o.EFFECTIVE_TO_DTTM) AND (o.DELETED_FLG = '0') AND (o.IS_ACTIVE_FLG = '1')
WHERE (c.CONTRACT_TYPE_CD = 'КРЕДИТ') AND (c.CONTRACT_STATUS_CD NOT IN ('АНКЛ', 'БВВД', 'БВВЗ', 'ВВЕД', 'ВВИВ', 'ВВРВ', 'ВВРД')) 
AND (c.PRODUCT_OPERATIONAL_ID IN ('МН', 'ПМ', 'ПШ', 'ПЭ', 'ПЯ', 'РЛ', 'РМ', 'РЦ', 'РЮ')) AND (c.DELETED_FLG = '0') AND (c.IS_ACTIVE_FLG = '1')
) WITH DATA PRIMARY INDEX (AGREEMENT_RK);

