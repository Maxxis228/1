DROP TABLE ADVANCES_simple;
CREATE TABLE ADVANCES_simple AS
(
SELECT
CURRENT_DATE - EXTRACT(DAY FROM CURRENT_DATE) AS REPORT_DT,
C.GENERATION, C.PRODUCT_ID, C.SUBPRODUCT_ID,
C.AGREEMENT_RK, C.BRANCH_ID, C.CONTRACT_ID, C.BRANCH_ID||C.CONTRACT_ID AS ID,
C.TERM, C.CLOSE_DT, C.POS_ID, C.POS_NAME, C.REGION, 
C.CONTRACT_AMT, C.OPEN_DT, C.ISSUE_DT, PL_FLG, RATE, PLEDGE_TYPE
FROM 

(SELECT
DISTINCT
C.AGREEMENT_RK,
TRUNC(COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT), 'MM') AS GENERATION,
C.SOURCE_SYSTEM_CD AS BRANCH_ID,
C.CONTRACT_ID,
COALESCE(SUM(LIM.CREDIT_LIMIT_AMT) OVER (PARTITION BY C.AGREEMENT_RK), C.CONTRACT_AMT) AS CONTRACT_AMT,
COALESCE(C.MIGRATION_OPEN_DT, C.OPEN_DT) AS OPEN_DT,
COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT) AS ISSUE_DT,
C.PRODUCT_OPERATIONAL_ID AS PRODUCT_ID,
C.PRODUCT_SUB_ID AS SUBPRODUCT_ID, CASE WHEN PL.AGREEMENT_RK IS NOT NULL THEN 1 ELSE 0 END AS PL_FLG,
CASE 
WHEN PL.PLEDGE_TYPE >= 1000 THEN 'Недвижимость'
WHEN PL.PLEDGE_TYPE >= 10 THEN 'Транспорт'
WHEN PL.PLEDGE_TYPE >= 0.1 THEN 'Оборудование'
WHEN PL.PLEDGE_TYPE >= 0.001 THEN 'ТМЦ'
WHEN PL.PLEDGE_TYPE = 0 THEN 'Нет'
END AS PLEDGE_TYPE,
COALESCE(C.INIT_INTERNAL_ORG_2_RK, C.INIT_INTERNAL_ORG_RK) AS POS_DEPT_RK,
P.POS_ID, P.POS_ID || ' ' || P.POS_NM AS POS_NAME, P.REGION, R.RATE,
CASE
	WHEN PERIOD_TYPE = 'дней'
	THEN C.CONTRACT_PERIOD
	WHEN C.CONTRACT_PERIOD IS NOT NULL
	THEN ADD_MONTHS(COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT), C.CONTRACT_PERIOD) - COALESCE(C.MIGRATION_OPEN_DT, C.ISSUE_DT)
	WHEN C.CONTRACT_PERIOD IS NULL AND CLOSE_PLAN_DT IS NOT NULL
	THEN CLOSE_PLAN_DT - COALESCE(CASE WHEN OPEN_DT >= DATE '2005-01-01' THEN OPEN_DT END, C.MIGRATION_OPEN_DT, C.ISSUE_DT)
END AS TERM,
CASE WHEN C.CLOSE_DT < CURRENT_DATE THEN C.CLOSE_DT ELSE CLOSE_PLAN_DT END AS CLOSE_DT

FROM DDS.CONTRACT_LN C

LEFT JOIN 
(
SELECT 
AGREEMENT_RK, SOURCE_SYSTEM_CD, DELETED_FLG, IS_ACTIVE_FLG,
SUM(
CASE 
	WHEN (SUBSTR(COLLATERAL_TYPE_CD,1,3) IN ('3.1', '3.6', '3.7', '3.8')) OR (COLLATERAL_TYPE_CD = '3.9.6') THEN 1000 
	WHEN (SUBSTR(COLLATERAL_TYPE_CD,1,3) = '3.4') THEN 10
	WHEN (SUBSTR(COLLATERAL_TYPE_CD,1,3) = '3.5') AND (COLLATERAL_TYPE_CD ^= '3.5.8') THEN 0.1
	WHEN (SUBSTR(COLLATERAL_TYPE_CD,1,3) IN ('3.2','3.3')) OR (COLLATERAL_TYPE_CD IN ('3','3.5.8','3.9.1','3.9.2','3.9.4','3.9.6')) THEN 0.001
	ELSE 0
END ) AS PLEDGE_TYPE 
FROM DDS.AGREEMENT_PLEDGE_HIST 
WHERE DELETED_FLG = '0' 
AND IS_ACTIVE_FLG = '1'
GROUP BY AGREEMENT_RK, SOURCE_SYSTEM_CD, DELETED_FLG, IS_ACTIVE_FLG
) PL 
ON  C.AGREEMENT_RK=PL.AGREEMENT_RK 
AND C.SOURCE_SYSTEM_CD=PL.SOURCE_SYSTEM_CD 

LEFT JOIN POS P
ON P.ORG_RK = COALESCE(C.INIT_INTERNAL_ORG_2_RK, C.INIT_INTERNAL_ORG_RK)

LEFT JOIN DDS.AGREEMENT_CREDIT_LIMIT_HIST LIM
ON LIM.AGREEMENT_RK = C.AGREEMENT_RK
AND LIM.AGREEMENT_TYPE_CD = C.CONTRACT_TYPE_CD
AND LIM.START_DT = C.ISSUE_DT
AND LIM.EFFECTIVE_FROM_DTTM <= CURRENT_DATE
AND LIM.EFFECTIVE_TO_DTTM >= CURRENT_DATE
AND LIM.DELETED_FLG = '0'
AND LIM.IS_ACTIVE_FLG = '1'

	LEFT JOIN
		DDS.AGREEMENT_RATE_HIST R
			ON
				R.AGREEMENT_RK = C.AGREEMENT_RK
				AND
				R.AGREEMENT_TYPE_CD = C.CONTRACT_TYPE_CD
				AND
				R.EFFECTIVE_FROM_DTTM <= C.ISSUE_DT
				AND
				R.EFFECTIVE_TO_DTTM >= C.ISSUE_DT
				AND
				R.DELETED_FLG = '0'
				AND
				R.IS_ACTIVE_FLG = '1'


WHERE
C.CONTRACT_TYPE_CD = 'КРЕДИТ'
AND C.CONTRACT_STATUS_CD NOT IN ('АНКЛ', 'БВВД', 'БВВЗ', 'ВВЕД', 'ВВИВ', 'ВВРВ', 'ВВРД')
AND C.PRODUCT_OPERATIONAL_ID IN ('МН', 'ПМ', 'ПЭ', 'ПШ', 'ПЯ', 'РЛ', 'РМ', 'РЦ', 'РЮ') 
AND C.TRANCHE_NUM IS NULL
AND C.DELETED_FLG = '0'
) C
WHERE C.GENERATION >= DATE '2012-01-01'
) WITH DATA PRIMARY INDEX (AGREEMENT_RK);

ALTER TABLE ADVANCES_simple ADD PLAN_SEGMENT VARCHAR(50) NOT NULL DEFAULT ' ', ADD PR_MANAGER VARCHAR(200) NOT NULL DEFAULT ' ';
UPDATE ADVANCES_simple FROM seg_ cc
SET PLAN_SEGMENT = COALESCE(cc.PLAN_SME_PROFIT_MODEL_CD, ' '),
PR_MANAGER = COALESCE(cc.PRIOR_MANAGER_FULL_NM, ' ')
WHERE ADVANCES_simple.AGREEMENT_RK = cc.AGREEMENT_RK;

